package ipmimon

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

const testingP097CSV = `ID,Name,Type,State,Reading,Units,Event
18,UID Light,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
20,01-Inlet Ambient,Temperature,Nominal,26.00,C,'OK'
21,02-CPU 1,Temperature,Nominal,40.00,C,'OK'
22,03-CPU 2,Temperature,Nominal,40.00,C,'OK'
23,04-P1 DIMM 1-6,Temperature,Nominal,32.00,C,'OK'
24,05-P2 DIMM 1-6,Temperature,Nominal,30.00,C,'OK'
25,06-P1 Mem Zone,Temperature,Nominal,29.00,C,'OK'
26,07-P1 Mem Zone,Temperature,Nominal,30.00,C,'OK'
27,08-P1 Mem Zone,Temperature,Nominal,30.00,C,'OK'
28,09-P2 Mem Zone,Temperature,Nominal,25.00,C,'OK'
29,10-P2 Mem Zone,Temperature,Nominal,25.00,C,'OK'
30,11-P2 Mem Zone,Temperature,Nominal,25.00,C,'OK'
32,13-Chipset,Temperature,Nominal,45.00,C,'OK'
33,14-Chipset Zone,Temperature,Nominal,34.00,C,'OK'
34,15-P/S 1,Temperature,Nominal,23.00,C,'OK'
35,16-P/S 2,Temperature,Nominal,0.00,C,'OK'
36,17-P/S 1 Zone,Temperature,Nominal,24.00,C,'OK'
37,18-P/S 2 Zone,Temperature,Nominal,25.00,C,'OK'
38,19-VR P1,Temperature,Nominal,31.00,C,'OK'
39,20-VR P2,Temperature,Nominal,28.00,C,'OK'
40,21-VR P1 Mem,Temperature,Nominal,32.00,C,'OK'
41,22-VR P2 Mem,Temperature,Nominal,27.00,C,'OK'
44,26-iLO LOM,Temperature,Nominal,34.00,C,'OK'
46,28-LOM Zone,Temperature,Nominal,29.00,C,'OK'
49,31-PCI 1 Zone,Temperature,Nominal,29.00,C,'OK'
50,32-PCI 2 Zone,Temperature,Nominal,27.00,C,'OK'
51,33-System Board,Temperature,Nominal,31.00,C,'OK'
52,34-System Board,Temperature,Nominal,30.00,C,'OK'
53,35-System Board,Temperature,Nominal,31.00,C,'OK'
54,36-Sys Exhaust,Temperature,Nominal,31.00,C,'OK'
55,37-Sys Exhaust,Temperature,Nominal,30.00,C,'OK'
57,Fan 1,Fan,Nominal,N/A,N/A,'transition to Running'
58,Fan 2,Fan,Nominal,N/A,N/A,'transition to Running'
59,Fan 3,Fan,Nominal,N/A,N/A,'transition to Running'
60,Fan 4,Fan,Nominal,N/A,N/A,'transition to Running'
61,Fan 5,Fan,Nominal,N/A,N/A,'transition to Running'
62,Fan 6,Fan,Nominal,N/A,N/A,'transition to Running'
63,Fan 7,Fan,Nominal,N/A,N/A,'transition to Running'
64,Fan 8,Fan,Nominal,N/A,N/A,'transition to Running'
65,Power Supply 1,Power Supply,Nominal,N/A,N/A,'Presence detected'
66,Power Supply 2,Power Supply,Critical,N/A,N/A,'Presence detected' 'Power Supply Failure detected'
67,Power Meter,Current,N/A,N/A,N/A,'Device Enabled'
68,Power Supplies,Power Supply,Critical,N/A,N/A,'Redundancy Lost'
70,Fans,Fan,Nominal,N/A,N/A,'Fully Redundant'
72,Memory,Memory,Nominal,N/A,N/A,'Presence detected'
`

const testingFujiOSCtrl003CSV = `ID,Name,Type,State,Reading,Units,Event
1,Ambient,Temperature,Nominal,23.00,C,'OK'
2,Systemboard,Temperature,Nominal,45.00,C,'OK'
3,VR CPU1,Temperature,Nominal,42.00,C,'OK'
4,VR MEM AB,Temperature,Nominal,31.00,C,'OK'
5,VR MEM CD,Temperature,Nominal,42.00,C,'OK'
6,VR CPU2,Temperature,Nominal,34.00,C,'OK'
7,VR MEM EF,Temperature,Nominal,37.00,C,'OK'
8,VR MEM GH,Temperature,Nominal,31.00,C,'OK'
9,CPU1,Temperature,Nominal,45.00,C,'OK'
10,CPU2,Temperature,Nominal,39.00,C,'OK'
11,MEM A,Temperature,Nominal,34.00,C,'OK'
12,MEM B,Temperature,Nominal,35.00,C,'OK'
13,MEM C,Temperature,Nominal,39.00,C,'OK'
14,MEM D,Temperature,Nominal,38.00,C,'OK'
15,MEM E,Temperature,Nominal,37.00,C,'OK'
16,MEM F,Temperature,Nominal,35.00,C,'OK'
17,MEM G,Temperature,Nominal,32.00,C,'OK'
18,MEM H,Temperature,Nominal,33.00,C,'OK'
19,PSU1 Inlet,Temperature,Nominal,37.00,C,'OK'
20,PSU2 Inlet,Temperature,Nominal,37.00,C,'OK'
21,PSU1,Temperature,Nominal,63.00,C,'OK'
22,PSU2,Temperature,Nominal,63.00,C,'OK'
25,BATT 3.0V,Voltage,Nominal,3.01,V,'OK'
26,STBY 12V,Voltage,Nominal,11.94,V,'OK'
27,STBY 5V,Voltage,Nominal,5.00,V,'OK'
28,STBY 3.3V,Voltage,Nominal,3.32,V,'OK'
29,LAN 1.8V STBY,Voltage,Nominal,1.78,V,'OK'
30,iRMC 1.0V STBY,Voltage,Nominal,0.97,V,'OK'
31,LAN 1.0V STBY,Voltage,Nominal,0.98,V,'OK'
32,MAIN 12V,Voltage,Nominal,12.18,V,'OK'
33,MAIN 5V,Voltage,Nominal,4.95,V,'OK'
34,MAIN 3.3V,Voltage,Nominal,3.35,V,'OK'
35,PCH 1.5V,Voltage,Nominal,1.50,V,'OK'
36,PCH 1.1V,Voltage,Nominal,1.11,V,'OK'
37,FAN1 SYS,Fan,Nominal,2880.00,RPM,'OK'
38,FAN2 SYS,Fan,Nominal,3000.00,RPM,'OK'
39,FAN3 SYS,Fan,Nominal,2880.00,RPM,'OK'
40,FAN4 SYS,Fan,Nominal,3000.00,RPM,'OK'
41,FAN5 SYS,Fan,Nominal,2880.00,RPM,'OK'
42,FAN6 SYS,Fan,Nominal,3000.00,RPM,'OK'
43,FAN7 SYS,Fan,Nominal,2880.00,RPM,'OK'
44,FAN8 SYS,Fan,Nominal,3000.00,RPM,'OK'
45,FAN9 SYS,Fan,Nominal,2880.00,RPM,'OK'
46,FAN10 SYS,Fan,Nominal,3000.00,RPM,'OK'
47,FAN11 SYS,Fan,Nominal,2880.00,RPM,'OK'
48,FAN12 SYS,Fan,Nominal,3000.00,RPM,'OK'
49,FAN PSU1,Fan,Nominal,2880.00,RPM,'OK'
50,FAN PSU2,Fan,Nominal,2800.00,RPM,'OK'
51,PSU1 Power,Other Units Based Sensor,Nominal,52.00,W,'OK'
52,PSU2 Power,Other Units Based Sensor,Nominal,52.00,W,'OK'
53,Total Power,Other Units Based Sensor,Nominal,104.00,W,'OK'
54,Total Power Out,Other Units Based Sensor,Nominal,76.00,W,'OK'
55,I2C1 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
56,I2C2 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
57,I2C3 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
58,I2C4 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
59,I2C5 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
60,I2C6 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
61,I2C7 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
62,I2C8 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
63,SEL Level,Monitor ASIC/IC,Nominal,0.00,%,'OK'
64,Ambient,Temperature,N/A,N/A,N/A,'Device Inserted/Device Present'
65,Ambient,Temperature,Nominal,N/A,N/A,'Limit Not Exceeded'
66,CPU1,Processor,Nominal,N/A,N/A,'Processor Presence detected'
67,CPU2,Processor,Nominal,N/A,N/A,'Processor Presence detected'
68,Power Limit,Power Unit,N/A,N/A,N/A,'Limit Not Exceeded'
69,Power Unit,Power Unit,Nominal,N/A,N/A,'Fully Redundant'
70,PSU Config,Version Change,Warning,N/A,N/A,'Hardware change detected with associated Entity'
72,PSU1,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
73,PSU2,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
74,Power Level,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0008h'
75,P-STATE Throttle,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
76,System State,System Event,N/A,N/A,N/A,'OK'
77,FAN1 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
78,FAN2 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
79,FAN3 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
80,FAN4 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
81,FAN5 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
82,FAN6 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
83,FAN7 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
84,FAN8 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
85,FAN9 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
86,FAN10 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
87,FAN11 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
88,FAN12 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
89,FAN PSU1,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
90,FAN PSU2,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
91,Watchdog,Watchdog 2,Nominal,N/A,N/A,'OK'
92,CPU detection,System Event,Nominal,N/A,N/A,'OK'
93,ME,Management Subsystem Health,Nominal,N/A,N/A,'OK'
94,iRMC request,OEM Reserved,N/A,N/A,N/A,'OK'
95,I2C1,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
96,I2C2,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
97,I2C3,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
98,I2C4,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
99,I2C5,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
100,I2C6,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
101,I2C7,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
102,I2C8,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
103,Config backup,OEM Reserved,N/A,N/A,N/A,'OK'
104,FAN7 SYS,Entity Presence,Nominal,N/A,N/A,'Entity Present'
105,FAN8 SYS,Entity Presence,Nominal,N/A,N/A,'Entity Present'
106,FAN9 SYS,Entity Presence,Nominal,N/A,N/A,'Entity Present'
107,FAN10 SYS,Entity Presence,Nominal,N/A,N/A,'Entity Present'
108,PSU1 Power,Entity Presence,Nominal,N/A,N/A,'Entity Present'
109,PSU2 Power,Entity Presence,Nominal,N/A,N/A,'Entity Present'
110,Total Power,Entity Presence,Nominal,N/A,N/A,'Entity Present'
111,Total Power Out,Entity Presence,Nominal,N/A,N/A,'Entity Present'
112,Power Level,Entity Presence,Nominal,N/A,N/A,'Entity Present'
183,Local Monitor,Other Fru,N/A,N/A,N/A,'Device Enabled'
184,Pwr Btn override,System ACPI Power State,Nominal,N/A,N/A,'OK'
185,NMI,Critical Interrupt,Nominal,N/A,N/A,'OK'
187,iRMC,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0000h'
`

const testingFujiOSHv003CSV = `Caching SDR repository information: /root/.freeipmi/sdr-cache/sdr-cache-gm-srv-oshv-003.localhost
Caching SDR record 152 of 152 (current record ID 10864) 
ID,Name,Type,State,Reading,Units,Event
32,Ambient,Temperature,Nominal,23.50,C,'OK'
96,Systemboard 1,Temperature,Nominal,25.00,C,'OK'
160,Systemboard 2,Temperature,Nominal,32.00,C,'OK'
224,CPU1,Temperature,Nominal,36.00,C,'OK'
288,CPU2,Temperature,Nominal,37.00,C,'OK'
352,MEM A,Temperature,Nominal,30.00,C,'OK'
416,MEM B,Temperature,Nominal,30.00,C,'OK'
480,MEM C,Temperature,Nominal,30.00,C,'OK'
544,MEM D,Temperature,Nominal,30.00,C,'OK'
608,MEM E,Temperature,Nominal,30.00,C,'OK'
672,MEM F,Temperature,Nominal,30.00,C,'OK'
736,MEM G,Temperature,Nominal,30.00,C,'OK'
800,MEM H,Temperature,Nominal,30.00,C,'OK'
864,PSU1 Inlet,Temperature,Nominal,26.00,C,'OK'
928,PSU2 Inlet,Temperature,Nominal,26.00,C,'OK'
992,PSU1,Temperature,Nominal,53.00,C,'OK'
1056,PSU2,Temperature,Nominal,53.00,C,'OK'
1120,BATT 3.0V,Voltage,Nominal,3.09,V,'OK'
1184,STBY 12V,Voltage,Nominal,11.88,V,'OK'
1248,STBY 5V,Voltage,Nominal,5.10,V,'OK'
1312,STBY 3.3V,Voltage,Nominal,3.28,V,'OK'
1376,LAN 1.8V STBY,Voltage,Nominal,1.79,V,'OK'
1440,iRMC 1.5V STBY,Voltage,Nominal,1.49,V,'OK'
1504,LAN 1.0V STBY,Voltage,Nominal,0.98,V,'OK'
1568,MAIN 12V,Voltage,Nominal,12.16,V,'OK'
1632,MAIN 5V,Voltage,Nominal,4.98,V,'OK'
1696,MAIN 3.3V,Voltage,Nominal,3.35,V,'OK'
1760,PCH 1.5V,Voltage,Nominal,1.48,V,'OK'
1824,PCH 1.1V,Voltage,Nominal,1.08,V,'OK'
1888,CPU1 1.05V,Voltage,Nominal,1.04,V,'OK'
1952,CPU2 1.05V,Voltage,Nominal,1.04,V,'OK'
2016,FAN1 SYS,Fan,Nominal,4860.00,RPM,'OK'
2080,FAN2 SYS,Fan,Nominal,5100.00,RPM,'OK'
2144,FAN3 SYS,Fan,Nominal,4980.00,RPM,'OK'
2208,FAN4 SYS,Fan,Nominal,5100.00,RPM,'OK'
2272,FAN5 SYS,Fan,Nominal,5100.00,RPM,'OK'
2336,FAN PSU1,Fan,Nominal,1760.00,RPM,'OK'
2400,FAN PSU2,Fan,Nominal,1680.00,RPM,'OK'
2464,CPU1 Power,Other Units Based Sensor,Nominal,28.00,W,'OK'
2528,CPU2 Power,Other Units Based Sensor,Nominal,16.00,W,'OK'
2592,System Power,Other Units Based Sensor,Nominal,56.00,W,'OK'
2656,HDD Power,Other Units Based Sensor,Nominal,10.00,W,'OK'
2720,PSU1 Power,Other Units Based Sensor,Nominal,68.00,W,'OK'
2784,PSU2 Power,Other Units Based Sensor,Nominal,72.00,W,'OK'
2848,Total Power,Other Units Based Sensor,Nominal,140.00,W,'OK'
2912,Total Power Out,Other Units Based Sensor,Nominal,108.00,W,'OK'
2976,I2C1 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
3040,I2C2 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
3104,I2C3 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
3168,I2C4 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
3232,I2C5 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
3296,I2C6 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
3360,I2C7 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
3424,I2C8 error ratio,OEM Reserved,Nominal,0.00,%,'OK'
3488,SEL Level,Monitor ASIC/IC,Nominal,0.00,%,'OK'
3552,Ambient,Temperature,N/A,N/A,N/A,'Device Inserted/Device Present'
3600,CPU1,Processor,Nominal,N/A,N/A,'Processor Presence detected'
3648,CPU2,Processor,Nominal,N/A,N/A,'Processor Presence detected'
3696,Power Unit,Power Unit,Nominal,N/A,N/A,'Fully Redundant'
3744,PSU Config,Version Change,Warning,N/A,N/A,'Hardware change detected with associated Entity'
3840,PSU1,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
3888,PSU2,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
3936,Power Level,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0008h'
3984,P-STATE Throttle,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
4032,FAN1 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
4080,FAN2 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
4128,FAN3 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
4176,FAN4 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
4224,FAN5 SYS,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
4272,FAN PSU1,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
4320,FAN PSU2,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0001h'
4368,Watchdog,Watchdog 2,Nominal,N/A,N/A,'OK'
4464,CPU detection,System Event,Nominal,N/A,N/A,'OK'
4512,iRMC request,OEM Reserved,N/A,N/A,N/A,'OK'
4560,I2C1,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
4608,I2C2,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
4656,I2C3,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
4704,I2C4,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
4752,I2C5,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
4800,I2C6,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
4848,I2C7,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
4896,I2C8,OEM Reserved,N/A,N/A,N/A,'OEM Event = 0002h'
4944,Config backup,OEM Reserved,N/A,N/A,N/A,'OK'
4992,Systemboard Pwr,Entity Presence,Nominal,N/A,N/A,'Entity Present'
5040,PSU1 Power,Entity Presence,Nominal,N/A,N/A,'Entity Present'
5088,PSU2 Power,Entity Presence,Nominal,N/A,N/A,'Entity Present'
5136,Total Power,Entity Presence,Nominal,N/A,N/A,'Entity Present'
5184,Total Power Out,Entity Presence,Nominal,N/A,N/A,'Entity Present'
5232,Power Level,Entity Presence,Nominal,N/A,N/A,'Entity Present'
7968,Local Monitor,Other Fru,N/A,N/A,N/A,'Device Enabled'
8016,Pwr Btn override,System ACPI Power State,Nominal,N/A,N/A,'OK'
8064,NMI,Critical Interrupt,Nominal,N/A,N/A,'OK'
`

func TestParseCSV(t *testing.T) {
	testCases := []struct {
		name string
		csv  string
		typ  string
	}{
		{"p097", testingP097CSV, TypePowerSupply},
		{"os-ctrl-003", testingFujiOSCtrl003CSV, TypePowerUnit},
		{"os-hv-003", testingFujiOSHv003CSV, TypePowerUnit},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			assert := assert.New(t)

			report, err := ParseCSV([]byte(tc.csv))
			assert.NoError(err)
			assert.NotNil(report)

			psuReport := report.Type(tc.typ)
			assert.NotNil(psuReport)
		})
	}
}

func TestItem_Events(t *testing.T) {
	assert := assert.New(t)

	baseReport, err := ParseCSV([]byte(testingP097CSV))
	assert.NoError(err)

	line66rep := baseReport.Filter(func(it *Item) bool { return it.ID == 66 })
	if assert.NotEmpty(line66rep) {
		expected := []string{
			"Presence detected",
			"Power Supply Failure detected"}

		events := line66rep[0].Events()
		assert.Equal(expected, events)
	}
}
